{% extends "base.html" %} 
{% load static %}
{% load widget_tweaks %}   
{% block content %}
<style>
    /* --- Global & App Shell --- */
    :root {
        --primary-color: #2d3e50; 
        --secondary-color: #3498db; 
        --accent-orange: #e67e22;
        --accent-green: #27ae60; 
        --accent-red: #c0392b; 
        --accent-purple: #8e44ad; 
        --text-light: #f8f9fa;
        --text-dark: #34495e;
        --background-main: #e9ecef; 
        --background-calculator-face: #ffffff; 
        --button-grey-light: #f1f3f5; 
        --button-grey-medium: #e9ecef; 
        --button-grey-dark: #ced4da; 
        --border-color: #dee2e6;
        --shadow-color: rgba(0, 0, 0, 0.1);
    }
    
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #7f8c8d; 
        {% comment %} display: flex;
        justify-content: center;
        align-items: center; {% endcomment %}
        {% comment %} min-height: 100vh; {% endcomment %}
        color: var(--text-dark);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    .mobile-app-container {
        {% comment %} width: 375px; 
        height: 750px;  {% endcomment %}
        background-color: var(--background-main);
        border-radius: 24px; 
        box-shadow: 0 12px 38px var(--shadow-color), 0 8px 12px rgba(0,0,0,0.08);
        overflow: hidden; /* Crucial: Prevents content from spilling out */
        position: relative;
        display: flex;
        flex-direction: column;
        margin:12px 0;    }
    
    .app-bar {
        background-color: var(--primary-color);
        color: var(--text-light);
        padding: 0 15px; 
        display: flex;
        align-items: center;
        height: 60px; 
        box-sizing: border-box;
        flex-shrink: 0;
        box-shadow: 0 2px 4px var(--shadow-color);
        position: relative; /* Ensure it's on top of content-area by default */
        z-index: 100; /* Higher than content-area, lower than drawer overlay */
    }
    .app-bar h1 {
        font-size: 1.2em; 
        font-weight: 500;
        margin: 0;
        flex-grow: 1;
        text-align: left; 
        padding-left: 15px; 
        color: var(--text-light);

    }
    .icon-button {
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 1.6em; 
        padding: 8px; 
        cursor: pointer;
        line-height: 1; 
    }
    #hamburger-menu { margin-right: 0; }
    #history-icon-button { margin-left: auto; margin-right: 0; }
    #more-options-appbar { margin-left: 5px; }
    
    
    .navigation-drawer {
        position: absolute; top: 0; left: -290px; 
        width: 290px; height: 100%; background-color: var(--primary-color);
        color: var(--text-light); box-shadow: 3px 0 8px rgba(0,0,0,0.25);
        transition: left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
        z-index: 1000; /* Highest z-index for the drawer itself */
        padding-top: 60px; 
        overflow-y: auto;
    }
    .navigation-drawer.open { left: 0; }
    .drawer-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5); display: none;
        z-index: 999; /* Below drawer, above app-bar and content */
    }
    .drawer-overlay.open { display: block; }
    
    .navigation-drawer .drawer-header { padding: 15px; }
    .navigation-drawer h3 {
        font-size: 0.9em; text-transform: uppercase; color: var(--button-grey-dark);
        padding: 10px 15px 5px; margin: 10px 0 5px; font-weight: 500;
    }
    .navigation-drawer ul { list-style: none; padding: 0; margin: 0; }
    .navigation-drawer .drawer-item {
        display: flex; align-items: center; padding: 14px 20px;
        text-decoration: none; color: var(--text-light); font-size: 1em;
        transition: background-color 0.2s; font-weight: 400;
    }
    .navigation-drawer .drawer-item .icon { margin-right: 18px; font-size: 1.3em;}
    .navigation-drawer .drawer-item:hover,
    .navigation-drawer .drawer-item.active {
        background-color: rgba(255,255,255,0.15); 
    }
    .navigation-drawer hr { border-color: rgba(255,255,255,0.15); }
    
    
    .content-area {
        flex-grow: 1;
        /* overflow: hidden; -- Let individual views handle their scroll */
        position: relative; 
        display: flex; 
        background-color: var(--background-main); /* Ensure content area has a background */
    }
    .calculator-view {
        display: none !important; /* Hidden by default */
        width: 100%; 
        height: 100%; 
        box-sizing: border-box;
        flex-direction: column; 
        overflow-y: auto; /* Allow scrolling within a view */
        background-color: inherit; /* Inherit from content-area or set specific */
        padding: 0; /* Remove base padding, add to specific view sections */
    }
    
    .calculator-view.active-view {
        display: flex !important; /* Force display when active */
    }
    
    /* Specific flex-directions for views that need it when active */
    #general-calculator-view.active-view,
    .converter-view.active-view,
    .form-based-calc-view.active-view,
    #history-view.active-view {
        /* flex-direction: column; -- Already default for .calculator-view */
    }
    
    .placeholder-view.active-view {
        justify-content: center;
        align-items: center;
        padding: 30px; /* Give placeholders padding */
    }
    
    
    /* --- General Calculator Enhanced --- */
    #general-calculator-view { 
        background-color: var(--background-calculator-face); /* Face color */
    }
    .general-calc-display {
        flex: 1; 
        display: flex; flex-direction: column; justify-content: flex-end; 
        padding: 20px 20px 10px; text-align: right; overflow: hidden;
        min-height: 120px; 
        /* background-color: var(--background-calculator-face); -- Inherits from parent */
    }
    .expression-display {
        font-size: 2em; color: #777; min-height: 35px; 
        word-break: break-all; margin-bottom: 8px; font-weight: 300;
    }
    .expression-display .operator { color: var(--accent-orange); font-weight: 400; } 
    .result-display {
        font-size: 3.5em; color: var(--text-dark); min-height: 60px;
        font-weight: 400; line-height: 1.1;
    }
    .general-calc-buttons {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; 
        background-color: var(--button-grey-dark); 
        flex-shrink: 0; padding: 0; 
        border-top: 1px solid var(--button-grey-dark);
    }
    .general-calc-buttons button {
        font-size: 1.7em; padding: 22px 10px; border: none; border-radius: 0; 
        color: var(--text-dark); cursor: pointer; transition: background-color 0.05s ease-in-out;
        font-weight: 400; display: flex; justify-content: center; align-items: center;
    }
    .general-calc-buttons button:active { filter: brightness(0.9); }
    .general-calc-buttons .btn-num { background-color: var(--button-grey-light); } 
    .general-calc-buttons .btn-grey { background-color: var(--button-grey-medium); } 
    .general-calc-buttons .btn-clear { background-color: var(--accent-red); color: white; font-weight: 500;}
    .general-calc-buttons .btn-operator { background-color: var(--accent-orange); color: white; font-weight: 500;}
    .general-calc-buttons .btn-equals { background-color: var(--secondary-color); color: white; font-weight: 500;}
    .general-calc-buttons .icon-btn { font-size: 1.4em; } 
    
    /* --- Converter Views Enhanced --- */
    .converter-view { background-color: var(--background-main); } /* Ensure this has a background */
    .converter-form-area { padding: 20px 15px 10px; background-color: white; margin-bottom: 1px; }
    .converter-io { /* No changes needed if structure is fine */ }
    .converter-field { margin-bottom: 18px; }
    .converter-field label { font-size: 0.9em; color: #555; margin-bottom: 6px; font-weight: 500; }
    .converter-field .input-group { display: flex; gap: 8px; }
    .converter-field select, .converter-field input[type="text"] {
        flex: 1; padding: 14px; border: 1px solid var(--border-color); border-radius: 6px; 
        background-color: #fdfdfd; font-size: 1.05em; color: var(--text-dark);
    }
    .converter-field input[type="text"] { text-align: right; font-weight: 500; }
    .conversion-rate { font-size: 0.85em; color: #777; text-align: center; margin: 12px 0; }
    .converter-numpad {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; 
        background-color: #b0bec5; border-top: 1px solid #b0bec5;
        margin-top: auto; flex-shrink: 0;
    }
    .converter-numpad button {
        font-size: 1.5em; padding: 20px 10px; background-color: #eceff1; 
        color: var(--text-dark); border:none; cursor:pointer;
    }
    .converter-numpad button:active { filter: brightness(0.95); }
    .converter-numpad button.special-key { background-color: #cfd8dc; } 
    .converter-numpad button.clear-key { background-color: var(--accent-red); color: white; }
    .converter-numpad button.icon-btn { font-size: 1.4em; }
    
    /* --- Form-Based Calculators (Discount, VAT, etc.) --- */
    .form-based-calc-view { background-color: var(--background-main); }
    .form-based-calc-view h2 { display: none; } 
    .custom-form-layout { 
        background-color: white; margin-bottom: 0; overflow: hidden;
    }
    .form-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 18px 20px; border-bottom: 1px solid var(--border-color); font-size: 1em;
    }
    .form-row:last-child { border-bottom: none; }
    .form-row span:first-child { color: #444; font-weight: 500; } 
    .form-row input[type="number"], .form-row input[type="text"], .form-row select,
    .form-row .result-value {
        border: none; background: none; text-align: right; font-size: 1em;
        color: var(--result-text-color); font-weight: 500; flex-basis: 50%; 
        padding: 5px 0; 
    }
    .form-row input::placeholder { color: #aab8c5; }
    .form-row.result-row .result-value { color: var(--accent-green); font-size: 1.1em; } 
    .form-row.readonly .result-value { color: var(--text-dark); font-weight: normal; } 
    
    
    .calculate-button-form-view {
        display: block; width: calc(100% - 40px); margin: 20px auto; padding: 16px; font-size: 1.15em;
        background: linear-gradient(to right, var(--secondary-color), #5DADE2); 
        color: white; text-transform: uppercase; letter-spacing: 1px;
        border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        flex-shrink: 0;
    }
    .calculate-button-form-view:hover { filter: brightness(1.1); }
    
    .secondary-button {
        display: block; width: calc(100% - 40px); margin: 10px auto; padding: 12px; font-size: 0.95em;
        background-color: #b0bec5; color: var(--text-dark);
        border: none; border-radius: 6px; cursor: pointer;
    }
    
    .results-area-standalone { 
        margin: 0 20px 20px; padding: 18px; background-color: #e8eef1; 
        border-radius: 8px; text-align: left;
    }
    .results-area-standalone p { margin: 10px 0; color: var(--text-dark); font-size: 1.05em; }
    .results-area-standalone span { font-weight: bold; color: var(--accent-purple); }
    .loan-results p span { color: var(--accent-red); } 
    
    /* GPA Specific */
    .gpa-course-row { gap: 10px; }
    .gpa-course-row input { flex: 1; text-align: left; border: 1px solid var(--border-color) !important; border-radius: 4px; padding: 8px !important; }
    .gpa-course-row input.gpa-course-credits { flex-basis: 20%; text-align: center;}
    .gpa-course-row input.gpa-course-grade { flex-basis: 25%; text-align: center;}
    
    /* Programmer Calc Specific */
    .programmer-calc .form-row span:first-child { flex-basis: 30%; text-align: left;}
    
    
    /* --- History View Enhanced --- */
    #history-view { background-color: var(--background-main); padding:0; }
    .history-view-header { 
        padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
        border-bottom: 1px solid #eee; margin-bottom: 10px; flex-shrink: 0;
    }
    .history-view-header h2 { display: none; }
    #clear-all-history-btn { color: var(--text-dark); } 
    
    #main-history-list { 
        list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto;
        background-color: white; /* Give list a background */
    }
    #main-history-list li { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; display: flex; flex-direction: column; 
        align-items: flex-end; position: relative; 
    }
    #main-history-list .hist-expression { font-size: 1em; color: #555; }
    #main-history-list .hist-result { font-size: 1.3em; color: var(--accent-purple); }
    #main-history-list .hist-item-more {
        position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
        background: none; border: none; font-size: 1.3em; color: #aaa; cursor: pointer;
    }
    #history-cancel-btn {
        background-color: #d3d9de; color: var(--text-dark); font-weight: 500;
        width: calc(100% - 40px); margin: 20px auto; padding: 12px;
        border:none; border-radius:6px; font-size:1em; text-align:center; cursor:pointer; flex-shrink:0;
    }
    
    /* Placeholder View Enhanced */
    .placeholder-view { 
        background-color: var(--background-main); 
        text-align: center; 
        /* padding: 30px; -- Handled by .active-view rule */
    }
    .placeholder-view h2 { color: var(--primary-color); font-size: 1.6em; margin-bottom: 15px; font-weight: 500;}
    .placeholder-view p { font-size: 1.1em; color: #6c7a89; line-height: 1.6; }
</style>
<div class="mobile-app-container">
    <!-- App Bar -->
    <header class="app-bar">
        <h1 id="app-bar-title"> Calculator</h1>
        
    </header>

    

    <!-- Main Content Area -->
    <main class="content-area">
        <!-- General Calculator View (as before) -->
        <div id="general-calculator-view" class="calculator-view active-view">
            <div class="general-calc-display">
                <div id="general-expression" class="expression-display"></div>
                <div id="general-result" class="result-display">0</div>
            </div>
            <div class="general-calc-buttons">
                <button data-value="moreOps" class="btn-grey">...</button> <button data-value="^" class="btn-grey">xʸ</button> <button data-action="backspace" class="btn-grey icon-btn">⌫</button> <button data-action="clear-all" class="btn-clear">C</button>
                <button data-value="(" class="btn-grey">(</button> <button data-value=")" class="btn-grey">)</button> <button data-value="%" class="btn-grey">%</button> <button data-value="/" class="btn-operator">÷</button>
                <button data-value="7" class="btn-num">7</button> <button data-value="8" class="btn-num">8</button> <button data-value="9" class="btn-num">9</button> <button data-value="*" class="btn-operator">×</button>
                <button data-value="4" class="btn-num">4</button> <button data-value="5" class="btn-num">5</button> <button data-value="6" class="btn-num">6</button> <button data-value="-" class="btn-operator">−</button>
                <button data-value="1" class="btn-num">1</button> <button data-value="2" class="btn-num">2</button> <button data-value="3" class="btn-num">3</button> <button data-value="+" class="btn-operator">+</button>
                <button data-value="00" class="btn-num">00</button><button data-value="0" class="btn-num">0</button> <button data-value="." class="btn-num">.</button> <button data-action="equals" class="btn-equals">=</button>
            </div>
        </div>

     

     

   



    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("--- SCRIPT START: DOMContentLoaded ---");
    
        // --- App Shell Elements ---
        const navDrawer = document.getElementById('nav-drawer');
        const drawerOverlay = document.getElementById('drawer-overlay');
        const drawerItems = document.querySelectorAll('.drawer-item'); // NodeList
        const appBarTitle = document.getElementById('app-bar-title');
        const calculatorViews = document.querySelectorAll('.calculator-view'); // NodeList
        const historyIconButton = document.getElementById('history-icon-button');
    
        // --- General Calculator Elements ---
        const generalCalcView = document.getElementById('general-calculator-view');
        const generalCalcDisplayExpr = document.getElementById('general-expression');
        const generalCalcDisplayResult = document.getElementById('general-result');
        const generalCalcButtonsContainer = document.querySelector('#general-calculator-view .general-calc-buttons');
        let gcExpression = '';
        let gcLastResult = '';
        let gcJustCalculated = false;
    
        // ... (Declare other calculator element consts here - for now, focus on general calc)
        // Make sure these elements exist in your HTML if you uncomment them.
        // const fromCurrencySelect = document.getElementById('from-currency-select');
        // etc.
    
        let calculationHistory = [];
    
        // --- CORE APP SHELL LOGIC ---
        function toggleDrawer() {
            console.log("toggleDrawer called");
            if (navDrawer) navDrawer.classList.toggle('open');
            else console.error("navDrawer not found in toggleDrawer");
            if (drawerOverlay) drawerOverlay.classList.toggle('open');
            else console.error("drawerOverlay not found in toggleDrawer");
        }
    
      
    
       
    
        function switchView(viewId, title) {
            console.log(`--- switchView called for viewId: ${viewId}, title: ${title} ---`);
            if (!calculatorViews || calculatorViews.length === 0) {
                console.error("CRITICAL: calculatorViews NodeList is empty or not found in switchView.");
                return;
            }
            calculatorViews.forEach(view => {
                if (view) {
                    view.classList.remove('active-view');
                    view.style.display = 'none'; // Explicitly hide
                } else {
                    console.warn("A view in calculatorViews was null");
                }
            });
    
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active-view');
                // The CSS for .active-view should set display: flex !important;
                console.log(`View ${viewId} activated. Computed display: ${window.getComputedStyle(targetView).display}`);
                if (appBarTitle) {
                    appBarTitle.textContent = title;
                } else {
                    console.error("appBarTitle element NOT FOUND in switchView");
                }
            } else {
                console.error(`Target view with ID "${viewId}" NOT FOUND in switchView`);
            }
    
            if (navDrawer) navDrawer.classList.remove('open');
            if (drawerOverlay) drawerOverlay.classList.remove('open');
            console.log("--- switchView finished ---");
        }
    
      
    
        // --- GENERAL CALCULATOR LOGIC ---
        function gcUpdateDisplay() {
            if (!generalCalcDisplayExpr || !generalCalcDisplayResult) {
                console.error("General calculator display elements not found in gcUpdateDisplay!");
                return;
            }
            let formattedExpression = String(gcExpression).replace(/([\+\-\*\/%^()])/g, '<span class="operator">$1</span>');
            generalCalcDisplayExpr.innerHTML = formattedExpression || ' ';
            generalCalcDisplayResult.textContent = gcLastResult || (gcJustCalculated ? gcLastResult : '0');
            if (gcJustCalculated && String(gcExpression) === String(gcLastResult)) {
                generalCalcDisplayExpr.innerHTML = ' ';
            }
        }
    
        function gcHandleInput(value) {
            console.log("GC Input:", value);
            if (gcJustCalculated) {
                if (!['+', '-', '*', '/', '%', '^'].includes(value)) gcExpression = '';
                else gcExpression = String(gcLastResult);
                gcJustCalculated = false;
            }
            const segments = String(gcExpression).split(/[\+\-\*\/\%\^\(\)]/);
            const currentSegment = segments.pop() || "";
            if (value === '.' && currentSegment.includes('.')) return;
            
            gcExpression += value;
            gcUpdateDisplay();
        }
    
        function gcCalculate() {
            console.log("GC Calculate. Expression:", gcExpression);
            if (!gcExpression) return;
            try {
                let evalExpression = String(gcExpression).replace(/\^/g, '**');
                // evalExpression = gcCalculatePercentage(evalExpression); // Assuming gcCalculatePercentage is defined
                let openParenCount = (evalExpression.match(/\(/g) || []).length;
                let closeParenCount = (evalExpression.match(/\)/g) || []).length;
                evalExpression += ')'.repeat(Math.max(0, openParenCount - closeParenCount));
                
                const result = eval(evalExpression); // DANGER: eval is risky
                gcLastResult = parseFloat(result.toFixed(10)).toString();
                
                // calculationHistory.unshift({expression: gcExpression, result: gcLastResult});
                // if(calculationHistory.length > 50) calculationHistory.pop();
                
                gcExpression = gcLastResult; 
                gcJustCalculated = true;
            } catch (e) { 
                gcLastResult = 'Error'; 
                console.error("Eval error in gcCalculate:", e, "Original Expression:", gcExpression, "Evaluated as:", evalExpression); 
            }
            gcUpdateDisplay();
        }
    
        if (generalCalcButtonsContainer) {
            generalCalcButtonsContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const buttonElement = e.target;
                    const value = buttonElement.dataset.value; 
                    const action = buttonElement.dataset.action;
                    console.log("GC Button Clicked - Value:", value, "Action:", action);
    
                    if (value) gcHandleInput(value);
                    else if (action) {
                        switch (action) {
                            case 'clear-all': gcExpression = ''; gcLastResult = ''; gcJustCalculated = false; break;
                            case 'backspace': gcExpression = String(gcExpression).slice(0, -1); gcJustCalculated = false; break;
                            case 'equals': gcCalculate(); break;
                        }
                    }
                    gcUpdateDisplay();
                }
            });
            console.log("Event listener attached to generalCalcButtonsContainer.");
        } else {
            console.error("CRITICAL: generalCalcButtonsContainer NOT FOUND.");
        }
        
    
        // --- INITIAL SETUP ---
        console.log("--- Running Initial Setup ---");
        const defaultActiveDrawerItem = document.querySelector('.drawer-item[data-view="general-calculator-view"]');
        if (defaultActiveDrawerItem) {
             console.log("Default active drawer item found:", defaultActiveDrawerItem.dataset.view);
             let title = defaultActiveDrawerItem.textContent.replace(/^[^\w\s]+|[^\w\s]+$/g, "").trim();
             switchView('general-calculator-view', title); 
             defaultActiveDrawerItem.classList.add('active');
        } else { 
            console.warn("Default active drawer item not found. Attempting to fallback to General Calculator.");
            // Fallback even if item not found, assuming the view div exists
            if (document.getElementById('general-calculator-view')) {
                 switchView('general-calculator-view', 'Calculator');
            } else {
                console.error("CRITICAL: general-calculator-view div itself NOT FOUND for default setup.");
            }
        }
        
        if(generalCalcDisplayResult) {
            gcUpdateDisplay(); // Initial display for General Calc
            console.log("Initial gcUpdateDisplay called.");
        } else {
            console.error("generalCalcDisplayResult NOT FOUND for initial update.");
        }
        
       
    });
</script>

{% endblock content %}