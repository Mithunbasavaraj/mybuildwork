{% extends "base.html" %} 
{% load static %}
{% load widget_tweaks %} 

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">  

<div class="content">
    <div class="card">
        <div class="card-body">
            <div class="border-bottom mb-3 pb-3">
                <h4>Upload & Crop Pan Photo</h4>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Select Image</label>
                    <input type="file" id="imageInput" class="form-control" accept="image/*" />
                </div>
            </div>

            <div class="mb-3">
                <img id="preview" style="max-width:50%; width:40vh;">
            </div>

            <div class="mb-3">
                <button type="button" onclick="rotateLeft()" class="btn btn-secondary">↺ Rotate Left</button>
                <button type="button" onclick="rotateRight()" class="btn btn-secondary">↻ Rotate Right</button>
            </div>

            <form method="post" action="{% url 'base:update_pan_photo' pk %}" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Upload</button>
                <p id="uploadSuccess" style="color:green; display:none;">✅ Image uploaded successfully</p>
            </form>

        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
let cropper;

document.getElementById('imageInput').addEventListener('change', function (e) {
    const file = e.target.files[0];
    const img = document.getElementById('preview');
    img.src = URL.createObjectURL(file);

    img.onload = () => {
        if (cropper) cropper.destroy();
        cropper = new Cropper(img, {

            viewMode:1,
			autoCropArea: 1

        });
    };
});

function rotateLeft() {
    if (cropper) cropper.rotate(-90);
}

function rotateRight() {
    if (cropper) cropper.rotate(90);
}

document.getElementById('uploadForm').addEventListener('submit', function (e) {
    e.preventDefault();
    if (!cropper) return alert("Please select an image first");

	const canvas = cropper.getCroppedCanvas({
        width: 300,
        height: 300,
        imageSmoothingQuality: 'high'
    });
    canvas.toBlob(function (blob) {
        const formData = new FormData();
        formData.append('cropped_image', blob, "{{ pk }}_profile.jpg");

        fetch("{% url 'base:update_pan_photo' pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
		.then(res => window.location = "{% url 'base:admin_profile' pk %}" );
		
    }, 'image/jpeg', 0.8);
});

</script>

{% endblock content %}
